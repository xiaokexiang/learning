### JVM中经典的垃圾回收器

下图是来自<a href="https://blogs.oracle.com/jonthecollector/our-collectors">oracle官方博客</a>中介绍垃圾回收器之间的关系图。

![](https://image.leejay.top/image/20200817/GDG377Ck8xwv.jpg?imageslim)

> 黄色代表`新生代`，灰色代表`老年代`，两个垃圾回收器之间相连表示`这两个垃圾回收器组合使用`。
>
> `Serial & CMS` 与 `ParNew & Serial Old`两组 在`JDK8`中已过期，`JDK9`中已移除。

---

### 新生代收集器

以下三种收集器都采用的是`标记-复制算法`来实现收集器的回收逻辑。

#### Serial收集器

使用`单线程`工作的收集器，除了只会用`一个处理器或一个收集线程`去完成垃圾收集工作，更重要的是它在进行垃圾收集时，必须`暂停其他所有的工作线程(STW)`，直到收集结束。是`客户端模式`下默认新生代收集器。

> 客户端/服务端区别：client比server模式`启动速度更快`，当server比client模式`运行速度更快`。

相比其他垃圾收集器，`Serial收集器`时所有垃圾回收器里面`额外内存消耗最小的`，但`STW耗时是最长的`；对于`单核处理器或处理器核心较少`环境来说，由于没有线程交互的开销，`Serial收集器`可以获得`最高的单线程收集效率`。

```bash
-XX:+UseSerialGC 新生代 & 老年代都使用串行收集器
```

#### ParNew收集器

`ParNew收集器`本质上是`Serial收集器`的`多线程并行`版本。除了`同时使用多条线程`进行垃圾收集外，其余的和`Serial收集器`一致。

> 这里的并行指的是：`同一个时间有多个`这样的收集线程在协调工作，用户线程此时处于等待状态。

除了`Serial收集器`外，只有`ParNew收集器`能与`CMS收集器`配合工作。

```bash
# 新生代ParNew & 老年代CMS 是开启CMS下新生代默认收集器
-XX:+UseComcMarkSweepGC
# 新生代ParNew & 老年代SerialOld（JDK8后已过期）
-XX:+UseParNewGC  
```

因为线程交互的开销，在`单核处理器`下性能低于`Serial`，但是`多核心`下`ParNew`收集器还是很高效的。

```bash
# 垃圾收集的线程数为8
-XX:ParallelGCThreads=8
```

> 不设置此参数时，当`Cpu Cores < 8`时，`Threads=Cpu Cores`，否则 `Threads=3+(5*cores)/8）`。

#### Parallel Scavenge收集器

相比`ParNew收集器`目标是`减少用户线程的停顿时间`，`Paraller收集器`关注则是`可控制的吞吐量`。
$$
吞吐量 = 运行用户代码时间 / (运行用户代码时间 + 运行垃圾收集时间）
$$

> 假设JVM执行完成某个请求共需要100分钟，其中垃圾收集花费1分钟，那么吞吐量就是`99%`。
>
> `低停顿时间`适合`用户交互或保证服务响应`的程序。`高吞吐量`适合`最高效率`利用处理器资源，`尽快`完成程序的`运算任务`。
>
> `停顿时间`缩短是以牺牲`吞吐量和新生代空间`为代价的。如果我们将新生代设置的较小，虽然会减少每次回收的时间，但是会导致垃圾回收更加频繁，虽然停顿时间在减少，但是吞吐量在下降。

```bash
# 允许设置一个大于0的毫秒数，收集器尽量保证内存回收时间不超过该值
-XX:MaxGCPauseMillis
# 允许设置一个大于0小于100的整数n
# 系统将花费不超过 1/(1+n)的时间进行回收 假设n=99，那么不超过1%时间进行回收。
-XX:GCTimeRatio
# 自适应GC策略，自动调整新生代大小，老年代晋年龄等 区别于ParNew是Paraller独有
-XX:UseAdaptiveSizePolicy
```

---

### 老年代收集器

#### Serial Old收集器

是`Serial`收集器的老年代版本，`单线程`收集器，主要用于`客户端`模式下的HotSpot虚拟机使用。

在`服务端`模式下，有两个用途：JDK5及之前版本中与`Parallel Scavenge`配合使用；作为`CMS`收集器发生失败时的备用收集器。

#### Parallel Old收集器

JDK6推出，是`Parallel Scavenge`收集器的老年代版本，支持`多线程并发`收集，基于`标记-整理`算法实现。

`Parallel Old`配合`Parallel Scavenge`的组合，用于`注重吞吐量和处理器资源较为稀缺的`情况。

#### CMS收集器